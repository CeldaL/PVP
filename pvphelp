local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer

-- === NOMBRE SOBRE LA CABEZA CON DISTANCIA EN METROS ===
local function createNameTag(character, playerName, isTargeted)
	if not character then return end

	local head = character:FindFirstChild("Head") or character:WaitForChild("Head", 5)
	if not head or character:FindFirstChild("NameTag") then return end

	local billboard = Instance.new("BillboardGui")
	billboard.Name = "NameTag"
	billboard.Adornee = head
	billboard.Size = UDim2.new(0, 200, 0, 50)  -- Aumentamos el tamaño de la etiqueta
	billboard.StudsOffset = Vector3.new(0, 3, 0)
	billboard.AlwaysOnTop = true
	billboard.MaxDistance = math.huge

	local textLabel = Instance.new("TextLabel")
	textLabel.Parent = billboard
	textLabel.Size = UDim2.new(1, 0, 1, 0)
	textLabel.BackgroundTransparency = 1
	textLabel.TextColor3 = Color3.new(1, 1, 1)
	textLabel.TextStrokeTransparency = 0
	textLabel.TextScaled = true  -- Hacemos que el texto se ajuste al tamaño del label
	textLabel.Font = Enum.Font.SourceSansBold
	textLabel.TextSize = 40  -- Aumentamos el tamaño de la letra

	billboard.Parent = character

	-- === ACTUALIZACIÓN DE DISTANCIA EN TIEMPO REAL ===
	task.spawn(function()
		while character and character.Parent and head and LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart") do
			local root = LocalPlayer.Character.HumanoidRootPart
			local distance = (head.Position - root.Position).Magnitude

			-- Convertimos la distancia a centímetros
			local distanceInCm = distance * 28.35

			-- Convertimos la distancia a metros
			local distanceInMeters = distanceInCm / 100

			-- Opcional: cambiar color por distancia
			if distanceInMeters < 30 then
				textLabel.TextColor3 = Color3.fromRGB(0, 255, 0) -- Verde (cerca)
			elseif distanceInMeters < 100 then
				textLabel.TextColor3 = Color3.fromRGB(255, 255, 0) -- Amarillo (medio)
			else
				textLabel.TextColor3 = Color3.fromRGB(255, 0, 0) -- Rojo (lejos)
			end

			-- Actualizamos el texto con el nombre y la distancia en metros
			textLabel.Text = string.format("%s | %.2f m", playerName, distanceInMeters)
			task.wait(0.2)
		end
	end)
end

local function setupPlayer(player)
	if player == LocalPlayer then return end

	local function onCharacterAdded(character)
		createNameTag(character, player.Name, false)
	end

	if player.Character then
		onCharacterAdded(player.Character)
	end

	player.CharacterAdded:Connect(onCharacterAdded)
end

for _, player in pairs(Players:GetPlayers()) do
	setupPlayer(player)
end

Players.PlayerAdded:Connect(setupPlayer)

-- === ANTI FALL COOLDOWN EXTREMO ===
local function noFallCooldown(character)
	local humanoid = character:WaitForChild("Humanoid")

	humanoid.StateChanged:Connect(function(_, newState)
		if newState == Enum.HumanoidStateType.GettingUp then
			humanoid:ChangeState(Enum.HumanoidStateType.Running)
		elseif newState == Enum.HumanoidStateType.FallingDown or newState == Enum.HumanoidStateType.Physics then
			humanoid:ChangeState(Enum.HumanoidStateType.Freefall)
		end
	end)

	while humanoid and humanoid.Parent do
		if humanoid:GetState() == Enum.HumanoidStateType.GettingUp or humanoid:GetState() == Enum.HumanoidStateType.FallingDown then
			humanoid:ChangeState(Enum.HumanoidStateType.Running)
		end
		task.wait(0.01)
	end
end

LocalPlayer.CharacterAdded:Connect(noFallCooldown)
if LocalPlayer.Character then
	noFallCooldown(LocalPlayer.Character)
end

-- === ANTI RAGDOLL ===
local function preventRagdoll(character)
	local humanoid = character:WaitForChild("Humanoid")

	for _, v in ipairs(character:GetDescendants()) do
		if v:IsA("BallSocketConstraint") or v:IsA("HingeConstraint") or v:IsA("Motor6D") then
			v.Enabled = true
		end
	end

	humanoid.StateChanged:Connect(function(_, new)
		if new == Enum.HumanoidStateType.Physics or new == Enum.HumanoidStateType.FallingDown or new == Enum.HumanoidStateType.Ragdoll then
			humanoid:ChangeState(Enum.HumanoidStateType.GettingUp)
		end
	end)

	local function monitor()
		while character and character.Parent do
			if not humanoid or not humanoid.Parent then
				character:BreakJoints()
			end
			task.wait(0.5)
		end
	end

	task.spawn(monitor)
end

LocalPlayer.CharacterAdded:Connect(preventRagdoll)
if LocalPlayer.Character then
	preventRagdoll(LocalPlayer.Character)
end
